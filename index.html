<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scientific Calculator â€” V2 (Working)</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ------------------------------------------------------------------
       Modern Scientific Calculator â€” v2
       Focus: correctness, clarity, accessibility, and stable calculations.
       ------------------------------------------------------------------ */

    :root{
      --bg1: #ffecd2;
      --bg2: #fcb69f;
      --glass: rgba(255,255,255,0.08);
      --glass-border: rgba(255,255,255,0.2);
      --text: #071428;
      --muted: rgba(7,20,40,0.6);
      --num-grad: linear-gradient(135deg,#f0f4f8,#e6eef8);
      --op-grad: linear-gradient(135deg,#ff6a88,#ff9472);
      --sci-grad: linear-gradient(135deg,#43cea2,#185a9d);
      --func-grad: linear-gradient(135deg,#ffffff,#f0f3f7);
      --radius: 16px;
      --shadow: 0 10px 34px rgba(2,6,23,0.18);
      --transition: 260ms;
    }

    body.dark{
      --bg1:#0f1720;
      --bg2:#082032;
      --glass: rgba(10,14,22,0.5);
      --glass-border: rgba(255,255,255,0.04);
      --text: #e6eef8;
      --muted: rgba(230,240,255,0.85);
      --num-grad: linear-gradient(135deg,#0f2b3b,#163a51);
      --op-grad: linear-gradient(135deg,#ff416c,#ff4b2b);
      --sci-grad: linear-gradient(135deg,#7f53ac,#647dee);
      --func-grad: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      --shadow: 0 14px 48px rgba(0,0,0,0.6);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Roboto Mono',monospace;color:var(--text);}

    body{
      display:flex;align-items:center;justify-content:center;padding:2rem;
      background: radial-gradient(circle at 10% 10%, var(--bg1), transparent 12%),
                  radial-gradient(circle at 90% 90%, var(--bg2), transparent 18%);
      background-size:400% 400%;animation: bgShift 20s ease-in-out infinite;transition:background var(--transition);
    }
    @keyframes bgShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .app{width:min(1100px,98%);display:grid;grid-template-columns:1fr 360px;gap:1rem}

    .panel-main{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:var(--radius);padding:1rem;border:1px solid var(--glass-border);backdrop-filter:blur(8px);box-shadow:var(--shadow);}

    .top{display:flex;justify-content:space-between;align-items:center}
    .brand{font-weight:700}
    .controls{display:flex;gap:0.5rem;align-items:center}

    .display{padding:0.8rem;border-radius:10px;min-height:110px;display:flex;flex-direction:column;justify-content:center;align-items:flex-end;gap:0.2rem}
    .display .expr{font-size:0.95rem;color:var(--muted);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .display .val{font-size:2.5rem;font-weight:700;word-break:break-word}

    .keys{display:grid;grid-template-columns:repeat(6,1fr);gap:0.58rem;padding:0.6rem}
    .calculator.basic .keys{grid-template-columns:repeat(4,1fr)}

    button.key{border:none;border-radius:10px;padding:0.7rem;min-height:50px;font-size:1rem;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:transform 120ms,box-shadow 120ms}
    button.key:active{transform:translateY(2px)}

    .key.num{background:var(--num-grad);color:var(--text);font-weight:600}
    .key.op{background:var(--op-grad);color:#fff;font-weight:700}
    .key.sci{background:var(--sci-grad);color:#fff}
    .key.func{background:var(--func-grad);color:var(--text)}

    .span-2{grid-column:span 2}

    .side{background:var(--glass);padding:0.8rem;border-radius:12px;border:1px solid var(--glass-border);backdrop-filter:blur(6px)}
    .history{max-height:420px;overflow:auto}
    .history-item{display:flex;justify-content:space-between;padding:0.45rem;border-radius:8px;margin-bottom:0.3rem}

    @media (max-width:980px){.app{grid-template-columns:1fr}.side{order:2}}
  </style>
</head>
<body>
  <div class="app">
    <div class="panel-main calculator" id="calculator" role="application" aria-label="Scientific calculator">
      <div class="top">
        <div class="brand">Scientific Calculator â€” v2</div>
        <div class="controls">
          <button id="themeBtn" class="key func" title="Toggle theme">ðŸŒž</button>
          <label style="display:flex;align-items:center;gap:6px"><input id="degBtn" type="checkbox">Deg</label>
          <label style="display:flex;align-items:center;gap:6px"><input id="sciBtn" type="checkbox" checked>Scientific</label>
        </div>
      </div>

      <div class="display" id="display">
        <div class="expr" id="expr"> </div>
        <div class="val" id="val">0</div>
      </div>

      <div class="keys" id="keys">
        <!-- row1 -->
        <button class="key func" data-action="AC">AC</button>
        <button class="key func" data-action="CE">CE</button>
        <button class="key func" data-action="back">âŒ«</button>
        <button class="key func" data-action="ans">ANS</button>
        <button class="key func" data-action="open">(</button>
        <button class="key func" data-action="close">)</button>

        <!-- row2 -->
        <button class="key sci" data-action="pi">Ï€</button>
        <button class="key sci" data-action="e">e</button>
        <button class="key sci" data-action="fact">n!</button>
        <button class="key sci" data-action="pow2">xÂ²</button>
        <button class="key sci" data-action="pow">xÊ¸</button>
        <button class="key sci" data-action="sqrt">âˆš</button>

        <!-- row3 functions -->
        <button class="key sci" data-action="fn" data-fn="sin">sin</button>
        <button class="key sci" data-action="fn" data-fn="cos">cos</button>
        <button class="key sci" data-action="fn" data-fn="tan">tan</button>
        <button class="key sci" data-action="fn" data-fn="asin">asin</button>
        <button class="key sci" data-action="fn" data-fn="acos">acos</button>
        <button class="key sci" data-action="fn" data-fn="atan">atan</button>

        <!-- row4 -->
        <button class="key sci" data-action="fn" data-fn="sinh">sinh</button>
        <button class="key sci" data-action="fn" data-fn="cosh">cosh</button>
        <button class="key sci" data-action="fn" data-fn="tanh">tanh</button>
        <button class="key sci" data-action="fn" data-fn="ln">ln</button>
        <button class="key sci" data-action="fn" data-fn="log10">log10</button>
        <button class="key func" data-action="comma">,</button>

        <!-- numbers operators -->
        <button class="key num" data-insert="7">7</button>
        <button class="key num" data-insert="8">8</button>
        <button class="key num" data-insert="9">9</button>
        <button class="key op" data-insert="/">Ã·</button>
        <button class="key op" data-action="pm">Â±</button>
        <button class="key func" data-action="percent">%</button>

        <button class="key num" data-insert="4">4</button>
        <button class="key num" data-insert="5">5</button>
        <button class="key num" data-insert="6">6</button>
        <button class="key op" data-insert="*">Ã—</button>
        <button class="key sci" data-action="exp">eË£</button>
        <button class="key sci" data-action="ten">10Ë£</button>

        <button class="key num" data-insert="1">1</button>
        <button class="key num" data-insert="2">2</button>
        <button class="key num" data-insert="3">3</button>
        <button class="key op" data-insert="-">âˆ’</button>
        <button class="key sci" data-action="nth">nâˆšx</button>
        <button class="key func" data-action="mode">Mode</button>

        <button class="key num span-2" data-insert="0">0</button>
        <button class="key num" data-insert=".">.</button>
        <button class="key op" data-insert="+">+</button>
        <button class="key op" data-action="equals">=</button>
        <button class="key func" data-action="noop"> </button>
      </div>

    </div>

    <div class="side">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>History</strong>
        <div style="display:flex;gap:8px">
          <button id="clearHistory" class="key func">Clear</button>
          <button id="mute" class="key func">ðŸ”ˆ</button>
        </div>
      </div>
      <div class="history" id="history"></div>
      <div style="margin-top:10px;opacity:0.9">Angle: <span id="ang">Radians</span></div>
      <div style="margin-top:8px;font-size:0.9rem;color:var(--muted)">Press Enter to evaluate. Use parentheses and functions as usual.</div>
    </div>
  </div>

  <script>
    /* ============================
       Calculator v2 â€” Engine Notes
       - Uses token -> shunting-yard -> RPN evaluate pipeline
       - Explicit '(' and ')' buttons added (close parentheses present)
       - Degree/Radian aware trig functions
       - Percent and factorial handled as postfix operators
       - CE and AC behavior separated
       - Scientific mode hides sci buttons and reflows grid
       ============================ */

    (function(){
      const calculator = document.getElementById('calculator');
      const displayExpr = document.getElementById('expr');
      const displayVal = document.getElementById('val');
      const keys = document.getElementById('keys');
      const degBtn = document.getElementById('degBtn');
      const sciBtn = document.getElementById('sciBtn');
      const themeBtn = document.getElementById('themeBtn');
      const historyEl = document.getElementById('history');
      const clearHistory = document.getElementById('clearHistory');
      const muteBtn = document.getElementById('mute');
      const angLabel = document.getElementById('ang');

      let expr = '';
      let last = null;
      let history = [];
      let deg = false;
      let sci = true;
      let muted = true;

      function play(){ if(!muted) new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=').play().catch(()=>{}); }

      function setDisplay(){ displayExpr.textContent = expr || ''; }
      function setValue(v){ displayVal.textContent = String(v); }

      /* ---------------- Tokenizer ---------------- */
      function tokenize(input){
        const toks = [];
        let i=0;
        while(i < input.length){
          const ch = input[i];
          if(/\s/.test(ch)){ i++; continue; }
          if(/[0-9.]/.test(ch)){
            let num = ch; i++;
            while(i<input.length && /[0-9.]/.test(input[i])){ num += input[i++]; }
            if((num.match(/\./g) || []).length > 1) throw new Error('Invalid decimal');
            toks.push({type:'number', value: parseFloat(num)});
            continue;
          }
          if(/[a-zA-ZÏ€]/.test(ch)){
            let id = ch; i++;
            while(i<input.length && /[a-zA-Z0-9_Ï€]/.test(input[i])) id += input[i++];
            const low = id.toLowerCase();
            if(low === 'pi' || id === 'Ï€') toks.push({type:'const', value: Math.PI});
            else if(low === 'e') toks.push({type:'const', value: Math.E});
            else toks.push({type:'func', value: low});
            continue;
          }
          if(ch === '+'){ toks.push({type:'op', value:'+'}); i++; continue; }
          if(ch === '-'){ toks.push({type:'op', value:'-'}); i++; continue; }
          if(ch === '*'){ toks.push({type:'op', value:'*'}); i++; continue; }
          if(ch === '/' || ch === 'Ã·'){ toks.push({type:'op', value:'/'}); i++; continue; }
          if(ch === '^'){ toks.push({type:'op', value:'^'}); i++; continue; }
          if(ch === '%'){ toks.push({type:'post', value:'%'}); i++; continue; }
          if(ch === '!'){ toks.push({type:'post', value:'!'}); i++; continue; }
          if(ch === '('){ toks.push({type:'paren', value:'('}); i++; continue; }
          if(ch === ')'){ toks.push({type:'paren', value:')'}); i++; continue; }
          if(ch === ','){ toks.push({type:'comma'}); i++; continue; }
          throw new Error('Unknown char ' + ch);
        }

        // convert unary minus
        const out = [];
        for(let k=0;k<toks.length;k++){
          const t = toks[k];
          if(t.type === 'op' && t.value === '-'){
            const prev = out[out.length-1];
            if(!prev || prev.type === 'op' || (prev.type==='paren' && prev.value==='(') || prev.type==='comma'){
              out.push({type:'op', value:'u-'}); continue;
            }
          }
          out.push(t);
        }
        return out;
      }

      /* ---------------- Shunting Yard ---------------- */
      const PREC = {'u-':5, '!':5, '%':5, '^':4, '*':3, '/':3, '+':2, '-':2};
      const RIGHT = new Set(['^','u-']);

      function shunt(tokens){
        const output = [];
        const ops = [];
        for(const t of tokens){
          if(t.type === 'number' || t.type === 'const') output.push(t);
          else if(t.type === 'func') ops.push(t);
          else if(t.type === 'comma'){
            while(ops.length && !(ops[ops.length-1].type==='paren' && ops[ops.length-1].value==='(')) output.push(ops.pop());
            if(!ops.length) throw new Error('Misplaced comma');
          }
          else if(t.type === 'op' || t.type === 'post'){
            const op1 = t.value;
            while(ops.length){
              const top = ops[ops.length-1];
              if(top.type === 'func'){ output.push(ops.pop()); continue; }
              if(top.type === 'op' || top.type === 'post'){
                const op2 = top.value;
                const p1 = PREC[op1]||0, p2 = PREC[op2]||0;
                if((!RIGHT.has(op1) && p1 <= p2) || (RIGHT.has(op1) && p1 < p2)){ output.push(ops.pop()); continue; }
              }
              break;
            }
            ops.push(t);
          }
          else if(t.type === 'paren'){
            if(t.value === '(') ops.push(t);
            else {
              while(ops.length && !(ops[ops.length-1].type==='paren' && ops[ops.length-1].value==='(')) output.push(ops.pop());
              if(!ops.length) throw new Error('Mismatched parentheses');
              ops.pop();
              if(ops.length && ops[ops.length-1].type === 'func') output.push(ops.pop());
            }
          }
        }
        while(ops.length){ const t = ops.pop(); if(t.type==='paren') throw new Error('Mismatched parentheses'); output.push(t); }
        return output;
      }

      /* ---------------- RPN Evaluate ---------------- */
      function fact(n){ n = Math.floor(n); if(n<0) throw new Error('Factorial negative'); if(n>170) return Infinity; let f=1; for(let i=2;i<=n;i++) f*=i; return f; }

      function apply(op,a,b){ switch(op){ case '+': return a+b; case '-': return a-b; case '*': return a*b; case '/': if(b===0) throw new Error('Div by 0'); return a/b; case '^': return Math.pow(a,b); } }

      function evalRPN(rpn){
        const st = [];
        for(const t of rpn){
          if(t.type === 'number' || t.type === 'const') st.push(t.value);
          else if(t.type === 'op'){
            if(t.value === 'u-'){ const v = st.pop(); if(v===undefined) throw new Error('Missing'); st.push(-v); }
            else { const b = st.pop(); const a = st.pop(); if(a===undefined||b===undefined) throw new Error('Missing'); st.push(apply(t.value,a,b)); }
          }
          else if(t.type === 'post'){
            if(t.value === '!'){ const a = st.pop(); if(a===undefined) throw new Error('Missing'); st.push(fact(a)); }
            else if(t.value === '%'){ const a = st.pop(); if(a===undefined) throw new Error('Missing'); st.push(a/100); }
          }
          else if(t.type === 'func'){
            const name = t.value;
            if(name === 'root'){ const x = st.pop(); const n = st.pop(); if(n===undefined||x===undefined) throw new Error('root needs 2 args'); st.push(Math.pow(x,1/n)); }
            else if(name === 'pow'){ const b = st.pop(); const a = st.pop(); if(a===undefined||b===undefined) throw new Error('pow needs 2'); st.push(Math.pow(a,b)); }
            else if(name === 'ln'){ const a = st.pop(); if(a===undefined) throw new Error('ln'); if(a<=0) throw new Error('ln domain'); st.push(Math.log(a)); }
            else if(name === 'log10'){ const a = st.pop(); if(a===undefined) throw new Error('log10'); if(a<=0) throw new Error('log10 domain'); st.push(Math.log10 ? Math.log10(a) : Math.log(a)/Math.LN10); }
            else if(name==='sqrt'){ const a=st.pop(); if(a===undefined) throw new Error('sqrt'); if(a<0) throw new Error('sqrt neg'); st.push(Math.sqrt(a)); }
            else if(name==='exp'){ const a=st.pop(); if(a===undefined) throw new Error('exp'); st.push(Math.exp(a)); }
            else if(name==='ten'){ const a=st.pop(); if(a===undefined) throw new Error('10^'); st.push(Math.pow(10,a)); }
            else if(['sin','cos','tan'].includes(name)){
              const a=st.pop(); if(a===undefined) throw new Error(name+' missing'); const x = deg ? a*Math.PI/180 : a; if(name==='sin') st.push(Math.sin(x)); if(name==='cos') st.push(Math.cos(x)); if(name==='tan') st.push(Math.tan(x)); }
            else if(['asin','acos','atan'].includes(name)){
              const a=st.pop(); if(a===undefined) throw new Error(name+' missing'); let v; if(name==='asin') v=Math.asin(a); if(name==='acos') v=Math.acos(a); if(name==='atan') v=Math.atan(a); st.push(deg? v*180/Math.PI : v); }
            else if(['sinh','cosh','tanh'].includes(name)){
              const a=st.pop(); if(a===undefined) throw new Error(name+' missing'); if(name==='sinh') st.push(Math.sinh(a)); if(name==='cosh') st.push(Math.cosh(a)); if(name==='tanh') st.push(Math.tanh(a)); }
            else throw new Error('Unknown fn ' + name);
          }
        }
        if(st.length !== 1) throw new Error('Invalid expression');
        return st[0];
      }

      /* ---------------- Evaluate wrapper ---------------- */
      function evaluate(raw){
        // auto-close parentheses
        const open = (raw.match(/\(/g)||[]).length;
        const close = (raw.match(/\)/g)||[]).length;
        if(open>close) raw = raw + ')'.repeat(open-close);
        const tks = tokenize(raw);
        const rpn = shunt(tks);
        const v = evalRPN(rpn);
        if(typeof v !== 'number' || !isFinite(v)) throw new Error('Math error');
        return v;
      }

      /* ---------------- UI events ---------------- */
      function addHistory(expr, val){ history.unshift({expr, val}); if(history.length>200) history.pop(); renderHistory(); }
      function renderHistory(){ historyEl.innerHTML=''; history.forEach(h=>{ const div=document.createElement('div'); div.className='history-item'; div.innerHTML=`<div style="opacity:0.9">${h.expr}</div><div style="font-weight:700">${format(h.val)}</div>`; div.tabIndex=0; div.addEventListener('click', ()=>{ expr = h.expr; setDisplay(); }); historyEl.appendChild(div); }); }

      function format(n){ if(n===Infinity) return 'Infinity'; if(isNaN(n)) return 'NaN'; const a=Math.abs(n); if(a!==0 && (a>=1e12 || a<1e-8)) return Number(n).toExponential(10); return Number.isInteger(n)?String(n):String(Number(n).toFixed(12)).replace(/\.?(0+)$/,''); }

      keys.addEventListener('click', (ev)=>{
        const b = ev.target.closest('button'); if(!b) return; const action = b.dataset.action; const ins = b.dataset.insert;
        play(); if(ins) { expr += ins; setDisplay(); return; }
        if(action) handle(action, b);
      });

      function handle(action, btn){ try{
        switch(action){
          case 'AC': expr=''; displayVal.textContent='0'; return;
          case 'CE': expr = expr.replace(/(\d+\.?\d*)$/,''); setDisplay(); return;
          case 'back': expr = expr.slice(0,-1); setDisplay(); return;
          case 'ans': if(last!==null) expr += format(last); setDisplay(); return;
          case 'open': expr += '('; setDisplay(); return;
          case 'close': expr += ')'; setDisplay(); return;
          case 'pi': expr += 'Ï€'; setDisplay(); return;
          case 'e': expr += 'e'; setDisplay(); return;
          case 'fact': expr += '!'; setDisplay(); return;
          case 'pow2': expr += '^2'; setDisplay(); return;
          case 'pow': expr += '^'; setDisplay(); return;
          case 'sqrt': expr += 'sqrt('; setDisplay(); return;
          case 'fn': expr += (btn.dataset.fn || '') + '('; setDisplay(); return;
          case 'comma': expr += ','; setDisplay(); return;
          case 'pm': expr += '-('; setDisplay(); return;
          case 'percent': expr += '%'; setDisplay(); return;
          case 'exp': expr += 'exp('; setDisplay(); return;
          case 'ten': expr += 'ten('; setDisplay(); return;
          case 'nth': const n = prompt('Enter n for nth root'); const ni=parseFloat(n); if(!isNaN(ni)&&ni>0) expr += 'root('+ni+','; setDisplay(); return;
          case 'mode': sci = !sci; calculator.classList.toggle('basic', !sci); document.querySelectorAll('.key.sci').forEach(el=>el.style.display = sci? '':'none'); return;
          case 'equals': if(!expr || expr.trim()==='') return; try{ const v = evaluate(expr); last = v; displayVal.textContent = format(v); addHistory(expr, v); expr = String(format(v)); }catch(er){ displayVal.textContent='Error'; alert('Error: '+er.message); } return;
          case 'noop': return;
        }
      }catch(err){ alert('Error: '+err.message); }}

      // keyboard
      window.addEventListener('keydown', (e)=>{
        if(e.ctrlKey||e.metaKey) return; const k = e.key;
        if(/^[0-9]$/.test(k)){ expr += k; setDisplay(); e.preventDefault(); return; }
        if(k==='.') { expr += '.'; setDisplay(); e.preventDefault(); return; }
        if(k === '+'){ expr += '+'; setDisplay(); e.preventDefault(); return; }
        if(k === '-') { expr += '-'; setDisplay(); e.preventDefault(); return; }
        if(k === '*') { expr += '*'; setDisplay(); e.preventDefault(); return; }
        if(k === '/') { expr += '/'; setDisplay(); e.preventDefault(); return; }
        if(k === '('){ expr += '('; setDisplay(); e.preventDefault(); return; }
        if(k === ')'){ expr += ')'; setDisplay(); e.preventDefault(); return; }
        if(k === '%'){ expr += '%'; setDisplay(); e.preventDefault(); return; }
        if(k === 'Enter' || k === '='){ document.querySelector('button[data-action="equals"]').click(); e.preventDefault(); return; }
        if(k === 'Backspace'){ document.querySelector('button[data-action="back"]').click(); e.preventDefault(); return; }
        if(k === 'Escape'){ document.querySelector('button[data-action="AC"]').click(); e.preventDefault(); return; }
        if(k.toLowerCase()==='p'){ expr += 'Ï€'; setDisplay(); e.preventDefault(); return; }
      });

      degBtn.addEventListener('change', ()=>{ deg = degBtn.checked; angLabel.textContent = deg ? 'Degrees' : 'Radians'; });
      sciBtn.addEventListener('change', ()=>{ sci = sciBtn.checked; calculator.classList.toggle('basic', !sci); document.querySelectorAll('.key.sci').forEach(el=>el.style.display = sci? '':'none'); });
      themeBtn.addEventListener('click', ()=>{ document.body.classList.toggle('dark'); themeBtn.textContent = document.body.classList.contains('dark') ? 'ðŸŒ™' : 'ðŸŒž'; });

      clearHistory.addEventListener('click', ()=>{ history = []; renderHistory(); });
      muteBtn.addEventListener('click', ()=>{ muted = !muted; muteBtn.textContent = muted? 'ðŸ”ˆ':'ðŸ”‡'; });

      setDisplay();
    })();
  </script>
</body>
</html>
